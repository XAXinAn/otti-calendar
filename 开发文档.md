# OttiCalendar 前端技术开发文档

## 1. 整体架构设计

本应用采用典型的 **C/S (Client/Server)** 架构。前端作为“端侧智能”的载体，不仅负责 UI 展示，还承担了初级图片处理和 OCR 文本提取的任务，以减轻服务器压力并提升响应速度。

- **前端 (Flutter)**：负责用户交互、本地状态管理、端侧 OCR 识别。
- **后端 (SpringBoot)**：负责业务逻辑、数据持久化、大模型 (LLM) 接口中转。
- **端云交互**：采用 RESTful API 进行常规数据请求，AI 聊天建议采用 SSE (Server-Sent Events) 或 WebSocket 实现流式输出效果。

------

## 2. 前端技术栈选型

| **维度** | **选型组件** | **理由** |
| --- | --- | --- |
| **基础框架** | Flutter 3.x | 跨平台，能够高效实现复杂的自定义可爱风 UI。 |
| **状态管理** | `flutter_riverpod` | 比 Provider 更安全、更易于测试，适合复杂的日程逻辑。 |
| **网络请求** | `dio` | 支持拦截器，方便处理 Token 验证及日志记录。 |
| **本地存储** | `isar` | 高性能 NoSQL 数据库，适合存储离线日程。 |
| **图像选择** | `image_picker` | 用于从相机或相册中获取图片。 |
| **端侧 OCR** | `flutter_paddle_ocr` | PaddleOCR 模型，中文识别精准度高，适合复杂场景。 |
| **日历核心** | `table_calendar` | 灵活度高，支持深度定制“Otti”主题样式。 |

------

## 3. 核心功能模块详细设计

### 3.1 视图管理模块 (Calendar View)

- **逻辑层**：维护一个 `SelectedDate` 的状态。
- **表现层**：
  - **月视图**：核心视图，日期单元格下方根据日程类型显示不同的“Otti足迹”。

> **实现状态：**
> - **已实现** `table_calendar` 的集成，支持阳历、农历、节假日和调休信息的展示。
> - **已实现** 月/周视图的动态折叠和展开。

### 3.2 AI 助手与对话模块 (AI Chat)

- **交互流**：
  1. 用户输入文本/语音。
  2. 前端封装上下文（当前日期、用户时区）发送至后端。
  3. 后端调用大模型返回 **结构化 JSON** 和 **引导性回复**。
  4. 前端解析 JSON，弹出“日程确认卡片”。
- **UI 细节**：气泡对话框需具备“Otti毛绒感”的圆角阴影。

> **实现状态：**
> - **部分实现**：已创建 `chat_page.dart` 作为聊天界面，并完成了从侧边栏到该页面的导航。UI 包含一个符合设计风格的底部输入框。

### 3.3 专项：多路 OCR 输入方案 (Multi-Path OCR)

这是本项目最复杂的技术点，需分别处理：

1. **悬浮窗模式 (Floating Overlay)**：
   - 使用 `system_alert_window` (Android)。
   - 权限处理：需引导用户手动开启“显示在其他应用上层”权限。
   - 流程：点击悬浮球 -> 捕获当前屏幕区域 -> 调用本地 OCR 库提取文字。
   > **实现状态：**
   > - **开发中**：尝试使用 `system_alert_window` 插件，但由于该插件新旧版本API变更巨大且存在兼容性问题，该功能**尚未成功实现**，目前处于暂停状态。

2. **手势模式 (Global Gesture)**：
   - 在 App 根节点监听 `onPanUpdate`。
   - 设计特定轨迹（如 L 型滑动）唤起相册选择器。
   > **实现状态：**
   > - **未开始**。

3. **相册分享模式 (Share Intent)**：
   - **用户流程**: 用户在系统相册等应用中选择图片，通过系统分享功能将图片发送给 OttiCalendar。
   - **实现路径**: 配置 `AndroidManifest.xml` 和 `Info.plist` 注册分享入口，应用通过 `receive_sharing_intent` 插件监听并接收传入的图片文件路径。
   > **实现状态：**
   > - **未开始**。

4. **相机拍照模式 (Camera Capture)**:
   - **用户流程**: 用户在 App 内点击拍照按钮，直接使用相机拍摄图片进行识别。
   - **实现路径**: 使用 `image_picker` 插件调起系统相机进行拍照，获取图片后送入 OCR 识别流程。
   > **实现状态：**
   > - **已实现**：在“一键记录”标签页中，用户可通过相机按钮调起相机，拍摄的照片可被用于 OCR 识别。

5. **相册选择模式 (Gallery Selection)**:
   - **用户流程**: 用户在 App 内点击图片按钮，从相册中选择图片进行识别。
   - **实现路径**: 使用 `image_picker` 插件调起系统相册进行选择。
   > **实现状态：**
   > - **已实现**：在“一键记录”标签页中，用户可通过图片按钮从相册选择图片，用于 OCR 识别。


### 3.4 个人中心模块 (User Profile)
- **功能点**:
  - 用户登录/注册/登出。
  - 头像、昵称等个人信息的修改。
  - “Otti”主题个性化设置（例如：切换主题色）。
  - 数据同步/备份设置。
> **实现状态：**
> - **部分实现**：已创建 `main_drawer.dart` 作为侧边栏 UI，包含“AI聊天”等功能的入口。

### 3.5 日程群组模块 (Group/Shared Calendar)
- **核心概念**: 用户可以创建或加入群组，群组内的日程对所有成员可见。
- **功能点**:
  - 创建、加入、退出、解散群组。
  - 邀请新成员（通过链接或用户 ID）。
  - 在群组日历中创建/编辑日程。
  - 成员权限管理（管理员、普通成员）。
> **实现状态：**
> - **未开始**。

### 3.6 日程创建模块 (Schedule Creation)

> **实现状态：**
> - **已实现** “手动添加”功能，包含自定义的滚动轮日期选择器 (`CustomDatePicker`) 和时间选择器 (`CustomTimePicker`)。
> - **已实现** “标签化”的交互方式：选择日期/时间后，图标按钮会变为可删除的彩色标签，提供了直观、现代的用户体验。

------

## 4. 接口协议规约 (Data Contract)

### 4.1 日程对象实体 (Schedule Entity)

JSON
'''
{
  "id": "uuid",
  "title": "String",
  "startTime": "ISO8601 String",
  "endTime": "ISO8601 String",
  "location": "String",
  "remindBefore": "Integer (minutes)",
  "isAiGenerated": "Boolean",
  "rawSource": "String (OCR原文/AI对话原文)"
}
'''

### 4.2 OCR 解析接口 (Frontend -> Backend)

为了保护隐私和减少流量，前端先将图片转为文字，再发送给后端：

- **POST** `/api/v1/ai/parse-text`
- **Body**: `{ "text": "识别出的杂乱文字", "current_time": "..." }`
- **Return**: 结构化的 Schedule 对象。

------

## 5. 项目目录结构建议

Plaintext
'''
lib/
├── main.dart
├── app.dart           # 全局配置（主题、路由）
├── core/
│   ├── theme/        # Otti主题颜色、圆角、字体
│   ├── network/      # Dio 封装
│   └── utils/        # PaddleOCR 封装、日期格式化
├── features/         # 按功能分块
│   ├── calendar/     # 日历逻辑与视图
│   ├── chat/         # AI 聊天室
│   ├── ocr/          # 悬浮窗、分享监听逻辑
│   ├── schedule/     # 日程增删改查
│   ├── profile/      # 个人中心 (新增)
│   └── groups/       # 群组管理 (新增)
└── shared/           # 通用组件（可爱风按钮、对话框）
'''

------

## 6. 开发环境要求

- **Flutter SDK**: ^3.16.0
- **Dart SDK**: ^3.2.0
- **Java**: JDK 21 (用于 Android 构建)
- **Android**: Min SDK 24 (为了支持某些 OCR 特性)
- **iOS**: Deployment Target 12.0
